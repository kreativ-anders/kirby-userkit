name: Update Kirby Submodule

on:
  schedule:
    - cron: '0 6 1 * *'  # Monthly on 1st at 06:00 UTC
  workflow_dispatch:

jobs:
  update-kirby:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Configure Git (main + submodule)
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          cd kirby
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          cd -

      - name: Get previous kirby tag
        id: previous
        run: |
          cd kirby
          git fetch --tags
          prev_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "prev_tag=$prev_tag" >> $GITHUB_OUTPUT

      - name: Update kirby submodule
        run: |
          git submodule update --remote --checkout kirby

      - name: Get latest kirby tag after update
        id: latest
        run: |
          cd kirby
          git fetch --tags
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT

      - name: Skip if no tag or no change
        if: steps.latest.outputs.latest_tag == '' || steps.latest.outputs.latest_tag == steps.previous.outputs.prev_tag
        run: |
          echo "No new tag or tag unchanged — skipping PR creation."
          exit 0

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update kirby to ${{ steps.latest.outputs.latest_tag }}"
          title: "Update kirby submodule to ${{ steps.latest.outputs.latest_tag }}"
          body: |
            This PR updates the `kirby` submodule from **${{ steps.previous.outputs.prev_tag }}** to **${{ steps.latest.outputs.latest_tag }}**.

            🔍 [View changes on GitHub](https://github.com/getkirby/kirby/compare/${{ steps.previous.outputs.prev_tag }}...${{ steps.latest.outputs.latest_tag }})

          branch: "update-kirby-submodule"
          delete-branch: true
